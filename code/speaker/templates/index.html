{% extends "main_base.html" %}

{% block title %}Robotic Psychotic{% endblock %}

{% block extra_head %}
{{ super() }}
<style>
    .chat-container {
        position: fixed;
        top: 130px; 
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 500px;
        overflow-y: auto;
        padding: 20px;
        background-color: #28e3ea;
        border-radius: 8px;
    }
    
    .fixed-bottom {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        max-width: 500px;
        padding: 10px;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    
    .menu-container {
        width: 100%;
        display: flex;
        justify-content: flex-end;
        margin-bottom: 5px;
    }
    
    #assistant-select {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #c059ff;
        background-color: #f3ff12;
        color: #512b8d;
        font-size: 12px;
    }
    
    .input-row {
        display: flex;
        align-items: stretch; /* Changed to stretch to allow child elements to fill the container height */
        justify-content: space-between;
        width: 100%;
    }
    
    #user-input {
        flex-grow: 1;
        min-height: 50px;
        max-height: 150px;
        margin-right: 10px;
        padding: 5px 10px;
        border: 1px solid #c059ff;
        border-radius: 4px;
        resize: vertical;
        background-color: #fed0ff;
        overflow-y: auto;
    }
    
    button {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 4px;
        background-color: #7c0e52;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
        align-self: center; /* Centers the button vertically */
        flex-shrink: 0; /* Prevents the button from shrinking */
    }
</style>
{% endblock %}

{% block content %}
<div id="chat-container" class="chat-container">
    <div id="chat-history-content">
        <!-- Messages will be dynamically inserted here -->
    </div>
</div>
<div class="fixed-bottom">
    <div class="menu-container">
        <select id="assistant-select">
            <option value="hey karen">Karen</option>
            <option value="hey home assistant">Home Assistant</option>
            <option value="hey claude">Claude</option>
            <option value="hey opus">Claude (Opus)</option>
            <option value="hey chatgpt">ChatGPT</option>
        </select>
    </div>
    <div class="input-row">
        <textarea id="user-input" placeholder="Query the machine"></textarea>
        <button onclick="sendQuery()">Send</button>
    </div>
</div>
{% endblock %}

    {% block scripts %}
    <script>
        var isLoading = false;
        var isScrolledToBottom = true;
        let lastKnownBottomPosition;
    
        function setupSSE() {
            console.log("Setting up SSE connection");
            var source = new EventSource("/stream");
            
            source.onopen = function(event) {
                console.log("SSE connection opened", event);
            };
            
            source.onerror = function(error) {
                console.error("SSE connection error:", error);
            };
            
            source.onmessage = function(event) {
                console.log("Received raw SSE message:", event.data);
                try {
                    var data = JSON.parse(event.data);
                    console.log("Parsed SSE data:", data);
                    

                    // Check if this is a messages update event
                    if (data.type === 'messages_update') {
                        console.log("Received messages_update event");
                        if (data.data) {
                            var messagesData = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;
                            if (messagesData.messages) {
                                console.log("Calling updateChatHistory with:", messagesData.messages);
                                updateChatHistory(messagesData.messages);
                            } else {
                                console.error("No messages array in parsed data");
                            }
                        } else {
                            console.error("No data payload in messages_update event");
                        }
                    } else {
                        console.log("Received non-messages_update event:", data.type);
                    }
                } catch (error) {
                    console.error("Error parsing SSE message:", error);
                }
            };}
        
            function updateChatHistory(messages) {
                var chatContainer = document.getElementById('chat-container');
                var chatHistory = document.getElementById('chat-history-content');
                if (!chatContainer || !chatHistory) {
                    console.error("Chat container or history element not found");
                    return;
                }
                
                // Record the position from the bottom before updating
                var positionFromBottom = chatContainer.scrollHeight - (chatContainer.scrollTop + chatContainer.clientHeight);

                // Check if user is scrolled to the bottom
                var wasAtBottom = (function() {
                    var positionFromBottom = chatContainer.scrollHeight - (chatContainer.scrollTop + chatContainer.clientHeight);
                    var buffer = 20;
                    return positionFromBottom <= buffer;
                })();
              
            var newContent = '';
            messages.forEach(function(message, index) {
                console.log(`Formatting message ${index}:`, message);
                newContent += formatMessage(message);
            });
        
            console.log("New content to be inserted:", newContent);
            chatHistory.innerHTML = newContent;
            console.log("Chat history updated");
    
            // Scroll to bottom if user was at bottom before update
            if (wasAtBottom) {
        chatContainer.scrollTop = chatContainer.scrollHeight - chatContainer.clientHeight;
            } else {
                // Restore the position from the bottom
                chatContainer.scrollTop = chatContainer.scrollHeight - chatContainer.clientHeight - positionFromBottom;
            }
        }
            
        function formatMessage(message) {
            console.log("formatMessage called with:", message);
            let content = '';
            if (message.artifact && message.artifact.type === "application/vnd.ant.code") {
                return `<pre><code class="language-${message.artifact.language}">${message.artifact.content}</code></pre>`;
            }
            const { role, content: messageContent, function_request } = message;
            let functionRequest = '';
            if (function_request && function_request.trim()) {
                functionRequest = function_request
                    .replace(/^(speak_to_|chat_with_llm_|get_)/, '')
                    .replace('_status', '')
                    .replace(/_/g, ' ')
                    .replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            }
            switch (role) {
                case 'User':
                    content = `<b>User: </b>${messageContent}<br>`;
                    break;
                case 'Agent':
                    let agentPrefix = 'Agent';
                    if (functionRequest) {
                        agentPrefix = `${functionRequest}`;
                    }
                    content = `<b>${agentPrefix}: </b>${messageContent}<br>`;
                    break;
                case 'tool':
                    let toolContent = functionRequest ? 
                        `(${functionRequest}: ${messageContent})` : 
                        messageContent;
                    content = `<div style="text-align: center;"><i>${toolContent}</i></div>`;
                    break;
                case 'system':
                    let systemContent = functionRequest ? 
                        `(${functionRequest}: ${messageContent})` : 
                        messageContent;
                    content = `<b>System: </b>${systemContent}<br>`;
                    break;
                default:
                    content = `<b>${role}:</b> ${messageContent}<br>`;
            }
            console.log("Formatted message:", content);
            return content;
        }
       
        function sendQuery() {
            var input = $('#user-input').val().trim();
            if (input) {
                var wakeWord = $('#assistant-select').val();
                var fullQuery = wakeWord + " " + input;
                
                sendAjaxRequest('/query', { input: fullQuery }, function(response) {
                    $('#user-input').val('');
                });
            }
        }

        let isResizing = false;
let currentResizer;

function initResize() {
    const chatContainer = document.getElementById('chat-container');
    const fixedBottom = document.querySelector('.fixed-bottom');
    const userInput = document.getElementById('user-input');

    // Adjust chat container when window is resized
    window.addEventListener('resize', adjustChatContainerHeight);

    // Adjust textarea height on input
    userInput.addEventListener('input', adjustTextareaHeight);

    function adjustChatContainerHeight() {
        const windowHeight = window.innerHeight;
        const fixedBottomHeight = fixedBottom.offsetHeight;
        chatContainer.style.height = `${windowHeight - 130 - fixedBottomHeight}px`;
    }

    // Initial adjustment
    adjustChatContainerHeight();
}

function adjustTextareaHeight() {
    const textarea = document.getElementById('user-input');
    const fixedBottom = document.querySelector('.fixed-bottom');
    
    // Reset height to auto to get the correct scrollHeight
    textarea.style.height = 'auto';
    
    // Calculate the new height
    const newHeight = Math.min(Math.max(textarea.scrollHeight, 50), 150); // Min 50px, max 150px
    
    // Set the new height
    textarea.style.height = `${newHeight}px`;
    
    // Adjust the chat container height
    const chatContainer = document.getElementById('chat-container');
    const windowHeight = window.innerHeight;
    chatContainer.style.height = `${windowHeight - 130 - fixedBottom.offsetHeight}px`;
}

        function getPreference(key, callback) {
                fetch(`/get_preference/${key}`)
                    .then(response => response.json())
                    .then(data => callback(data[key]));
            }

            document.addEventListener('DOMContentLoaded', function() {
                sendAjaxRequest('/', {}, function() {
                    // No action needed with the response
                });

                fetch('/api/settings')
                    .then(response => response.json())
                    .then(settings => {
                        const selectElement = document.getElementById('assistant-select');
                        const botSettings = settings.preferences.default_bot;
                        selectElement.innerHTML = '';
                        botSettings.options.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.value;
                            optionElement.textContent = option.label;
                            selectElement.appendChild(optionElement);
                        });
                        
                        // Set the default bot
                        selectElement.value = botSettings.default;
                    })
                    .catch(error => {
                        console.error('Error fetching settings:', error);
                    });

                // send button listener
                document.querySelector('button').addEventListener('click', sendQuery);

                // listens for when the user presses the return key
                document.getElementById('user-input').addEventListener('keydown', function(e) {
                    // shift-return is line break
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); // Prevent default to avoid line break
                        sendQuery();
                    }
                });

                // when the user scrolls to the top of the chat,
                // we load older messages
                var chatContainer = document.getElementById('chat-container');
                if (chatContainer) {
                    chatContainer.addEventListener('scroll', function() {
                        if (chatContainer.scrollTop === 0) {
                            console.log("Scrolled to the very top!");
                            sendAjaxRequest('/scrolled_to_top', {}, function(response) {
                                console.log("Scrolled to top request processed", response);
                            });
                        }
                    });
                }
            });
                    
        setupSSE();

        

        function sendAjaxRequest(endpoint, data, successCallback) {
            $.ajax({
                url: endpoint,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: successCallback
            });
        }
    </script>
    {% endblock %}
</body>
</html>
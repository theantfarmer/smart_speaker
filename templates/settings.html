{% extends "main_base.html" %}

{% block title %}User Settings{% endblock %}

{% block extra_head %}
{{ super() }}
<style>
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
    }
    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group textarea {
        width: 100%;
        max-width: 500px;
        box-sizing: border-box;
        border-radius: 10px;  /* This adds rounded corners */
        padding: 2px;  /* This adds some internal padding */
        border: 1px solid #ccc;  /* This ensures a visible border */
    }
    .form-group textarea {
        min-height: 100px;
    }
    /* Add some focus styles for better user feedback */
    .form-group input[type="text"]:focus,
    .form-group input[type="password"]:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #9ecaed;
        box-shadow: 0 0 10px #9ecaed;
    }
    .password-field {
        position: relative;
        display: inline-block;
        width: 100%;
        max-width: 500px;
    }

    .toggle-password {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .cat-eye {
        width: 20px;
        height: 20px;
        color: #888;
    }

    .cat-eye.visible {
        color: #9ecaed;
    }
    .settings-section {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<h2>User Settings</h2>

<div id="settings-nav">
    {% for section in settings_structure %}
        <button onclick="showSection('{{ section }}')">{{ section|replace('_', ' ')|title }}</button>
    {% endfor %}
</div>

{% macro render_field(key, value, actual_value, parent_key='') %}
    {% set field_id = (parent_key + '_' + key if parent_key else key)|replace('.', '_') %}
    <div class="form-group">
        <label for="{{ field_id }}">{{ key|replace('_', ' ') }}</label>
        {% if value is mapping %}
            {% if value.get('type') == 'menu' %}
                <select id="{{ field_id }}" name="{{ field_id }}">
                    {% for option in value.options %}
                        <option value="{{ option.value }}" 
                                {% if option.value == actual_value.get('default', value.get('default')) %}selected{% endif %}>
                            {{ option.label }}
                        </option>
                    {% endfor %}
                </select>
            {% elif value.items()|list|length == 0 %}
                <textarea id="{{ field_id }}" name="{{ field_id }}" placeholder="Enter JSON key-value pairs" rows="4" cols="50">{{ actual_value|default(value)|tojson }}</textarea>
            {% else %}
                {% for sub_key, sub_value in value.items() %}
                    {{ render_field(sub_key, sub_value, actual_value.get(sub_key, sub_value) if actual_value is mapping else sub_value, field_id) }}
                {% endfor %}
            {% endif %}
        {% elif value is sequence and value is not string %}
            <textarea id="{{ field_id }}" name="{{ field_id }}" rows="4" cols="50">{{ actual_value|default(value)|join('\n') }}</textarea>
        {% else %}
            {% set is_api_key = 'key' in key.lower() or 'token' in key.lower() or 'secret' in key.lower() %}
            <div class="password-field">
                <input type="{% if is_api_key %}password{% else %}text{% endif %}" 
                       id="{{ field_id }}" 
                       name="{{ field_id }}" 
                       value="{{ actual_value|default(value) }}"
                       {% if is_api_key %}size="50" maxlength="256"{% endif %}
                >
                {% if is_api_key %}
                    <button type="button" class="toggle-password" data-target="{{ field_id }}">
                        <svg class="cat-eye" viewBox="0 0 100 100" width="20" height="20">
                            <path d="M50 20C25 20 5 50 5 50C5 50 25 80 50 80C75 80 95 50 95 50C95 50 75 20 50 20ZM50 70C39 70 30 61 30 50C30 39 39 30 50 30C61 30 70 39 70 50C70 61 61 70 50 70ZM50 42C45 42 42 45 42 50C42 55 45 58 50 58C55 58 58 55 58 50C58 45 55 42 50 42Z" fill="currentColor"/>
                        </svg>
                    </button>
                {% endif %}
            </div>
        {% endif %}
    </div>
{% endmacro %}

{% for section, content in settings_structure.items() %}
    <div id="{{ section }}" class="settings-section">
        <h3>{{ section|replace('_', ' ')|title }}</h3>
        <form id="{{ section }}-form">
            {% if content is mapping %}
                {% for key, value in content.items() %}
                    {{ render_field(key, value, actual_settings.get(section, {}).get(key, value)) }}
                {% endfor %}
            {% elif content is sequence and content is not string %}
                {% set actual_list = actual_settings.get(section, []) %}
                {% for item in content %}
                    {% if item is mapping %}
                        {% for key, value in item.items() %}
                            {% set actual_item = actual_list[loop.index0] if loop.index0 < actual_list|length else {} %}
                            {{ render_field(key, value, actual_item.get(key, value)) }}
                        {% endfor %}
                    {% else %}
                        <div class="form-group">
                            <input type="text" name="{{ section }}[]" value="{{ actual_list[loop.index0] if loop.index0 < actual_list|length else item }}">
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <div class="form-group">
                    <input type="text" name="{{ section }}" value="{{ actual_settings.get(section, content) }}">
                </div>
            {% endif %}
        </form>
        <button onclick="submitForm('{{ section }}-form')">Save {{ section|replace('_', ' ')|title }}</button>
    </div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
function showSection(sectionId) {
    document.querySelectorAll('.settings-section').forEach(section => {
        section.style.display = 'none';
    });
    document.getElementById(sectionId).style.display = 'block';
}
    
    function submitForm(formId) {
    const form = document.getElementById(formId);
    const formData = new FormData(form);
    const jsonData = {};
    
    formData.forEach((value, key) => {
        // Handle nested keys (e.g., "user_profile.name")
        const keys = key.split('.');
        let current = jsonData;
        for (let i = 0; i < keys.length - 1; i++) {
            if (!(keys[i] in current)) {
                current[keys[i]] = {};
            }
            current = current[keys[i]];
        }
        
        // Handle array inputs (e.g., wake_words)
        if (key.endsWith('[]')) {
            const arrayKey = keys[keys.length - 1].slice(0, -2);
            if (!(arrayKey in current)) {
                current[arrayKey] = [];
            }
            current[arrayKey].push(value);
        } else {
            current[keys[keys.length - 1]] = value;
        }
    });

    // Extract the setting type from the form ID (e.g., "user-profile-form" -> "user_profile")
    const settingType = formId.replace('-form', '').replace('-', '_');

    fetch('/api/settings?type=' + settingType, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(jsonData),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message); // Show a success message
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('An error occurred while saving the settings.');
    });
}

function setupPasswordToggles() {
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const input = document.getElementById(this.getAttribute('data-target'));
            const catEye = this.querySelector('.cat-eye');
            if (input.type === 'password') {
                input.type = 'text';
                catEye.classList.add('visible');
            } else {
                input.type = 'password';
                catEye.classList.remove('visible');
            }
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Hide all sections first
    document.querySelectorAll('.settings-section').forEach(section => {
        section.style.display = 'none';
    });

    // Then show only the first section
    const firstSection = document.querySelector('.settings-section');
    if (firstSection) {
        firstSection.style.display = 'block';
    }

    setupPasswordToggles();
});
</script>
{% endblock %}